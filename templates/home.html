{% extends "base.html" %}
{% load static %}

{% block title %}–ì–ª–∞–≤–Ω–∞—è - QuoteBox{% endblock %}

{% block content %}
    <div class="d-flex justify-content-center align-items-center" style="min-height: 70vh;">
        {% if quote %}
            <div class="card shadow-sm p-4 position-relative" style="max-width: 600px; width: 100%;">
                <blockquote class="blockquote mb-4">
                    <p class="fs-5">‚Äú{{ quote.text }}‚Äù</p>
                </blockquote>

                <footer class="blockquote-footer mb-4">
                    {% if quote.source.type == 'book' %}
                        –ö–Ω–∏–≥–∞ "{{ quote.source.name }}"
                    {% else %}
                        –ö–∏–Ω–æ—Ñ–∏–ª—å–º "{{ quote.source.name }}"
                    {% endif %}
                </footer>

                <div style="position: absolute; bottom: 10px; right: 15px;"
                     class="d-flex align-items-center text-muted">
                    <img src="{% static 'img/eye.png' %}" alt="–ø—Ä–æ—Å–º–æ—Ç—Ä—ã" width="18" height="18" class="me-1">
                    <span>{{ quote.views }}</span>
                </div>

                {% if user.is_authenticated %}
                    <div style="position: absolute; bottom: 10px; left: 15px; display: flex; gap: 10px;">
                        <button class="btn btn-outline-secondary btn-sm d-flex align-items-center vote-btn"
                                data-pk="{{ quote.pk }}" data-type="like">
                            üëç <span class="ms-1 likes-count" data-pk="{{ quote.pk }}">{{ quote.likes }}</span>
                        </button>
                        <button class="btn btn-outline-secondary btn-sm d-flex align-items-center vote-btn"
                                data-pk="{{ quote.pk }}" data-type="dislike">
                            üëé <span class="ms-1 dislikes-count" data-pk="{{ quote.pk }}">{{ quote.dislikes }}</span>
                        </button>
                    </div>
                {% else %}
                    <small class="text-muted position-absolute bottom-0 start-0 m-3">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —Å—Ç–∞–≤–∏—Ç—å
                        –ª–∞–π–∫–∏/–¥–∏–∑–ª–∞–π–∫–∏</small>
                {% endif %}

            </div>
        {% else %}
            <p class="text-muted">–¶–∏—Ç–∞—Ç –ø–æ–∫–∞ –Ω–µ—Ç. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é!</p>
        {% endif %}
    </div>

    {% if user.is_authenticated %}
        <script>
            document.addEventListener('DOMContentLoaded', () => {

                const updateButtonColors = (quoteId, userVote) => {
                    const likeBtn = document.querySelector(`.vote-btn[data-pk="${quoteId}"][data-type="like"]`);
                    const dislikeBtn = document.querySelector(`.vote-btn[data-pk="${quoteId}"][data-type="dislike"]`);

                    if (userVote === 1) {
                        likeBtn.classList.remove('btn-outline-secondary');
                        likeBtn.classList.add('btn-success');
                        dislikeBtn.classList.remove('btn-danger');
                        dislikeBtn.classList.add('btn-outline-secondary');
                    } else if (userVote === -1) {
                        dislikeBtn.classList.remove('btn-outline-secondary');
                        dislikeBtn.classList.add('btn-danger');
                        likeBtn.classList.remove('btn-success');
                        likeBtn.classList.add('btn-outline-secondary');
                    } else {
                        likeBtn.classList.remove('btn-success');
                        dislikeBtn.classList.remove('btn-danger');
                        likeBtn.classList.add('btn-outline-secondary');
                        dislikeBtn.classList.add('btn-outline-secondary');
                    }
                };

                document.querySelectorAll('.vote-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const pk = btn.dataset.pk;
                        const type = btn.dataset.type;

                        fetch(`/quote/${pk}/${type}/ajax/`, {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': '{{ csrf_token }}',
                                'Accept': 'application/json'
                            },
                        })
                            .then(response => response.json())
                            .then(data => {
                                document.querySelector(`.likes-count[data-pk="${pk}"]`).textContent = data.likes;
                                document.querySelector(`.dislikes-count[data-pk="${pk}"]`).textContent = data.dislikes;

                                updateButtonColors(pk, data.user_vote);
                            })
                            .catch(error => console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–∏:', error));
                    });
                });
            });
        </script>
    {% endif %}
{% endblock %}
